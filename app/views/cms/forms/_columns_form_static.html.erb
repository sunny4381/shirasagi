<%
  def find_column_value(column_values, column)
    column_values.where(column_id: column.id).first
  end
%>

<%= f.fields_for :column_values do |g| %>
  <% form.columns.order_by(order: 1, name: 1).each do |column| %>
    <% column_value = find_column_value(column_values, column) %>
    <%= render file: column.column_form_path, locals: { f: g, column: column, value: column_value, controller: false } %>
  <% end %>
<% end %>

<%= jquery do %>
  var $el = $(<%== "##{addon_id}".to_json %>);

  $el.find('a.btn-file-upload').data('on-select', function($item) {
    $.colorbox.close();

    var fileId = $item.data('id');
    var humanizedName = $item.data('humanized-name');
    if (! fileId || ! humanizedName) {
      return;
    }

    var $element = $.colorbox.element();
    $element.siblings('input.file-id').val(fileId);
    $element.siblings('span.humanized-name').text(humanizedName);
    $element.siblings('.btn-file-delete').show();
  });

  $el.on('click', 'a.btn-file-delete', function(e) {
    var $this = $(this);
    $this.siblings('input.file-id').val('');
    $this.siblings('span.humanized-name').text('');
    $this.hide();

    e.preventDefault();
    return false;
  });
<% end %>
