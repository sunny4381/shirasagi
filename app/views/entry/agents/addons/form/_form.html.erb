<%
  @item.form = Cms::Form.site(@cur_site).where(sub_type: "entry").first
%>

<%= f.hidden_field :form_id, value: @item.form.id %>

<%= f.fields_for :column_values do |g| %>
  <% @item.column_values.order_by(order: 1, name: 1).each do |column_value| %>
    <% column = column_value.column %>
    <% next if column.blank? %>
    <%= render file: column.entry_form_path, locals: { f: g, column: column, value: column_value, disabled: false } %>
  <% end %>

  <div class="entry-controller">
    <h3>追加</h3>
    <fieldset>
      <% @item.form.columns.order_by(order: 1).each do |column| %>
        <butotn type="button" class="btn btn-outline-primary" data-form-id="<%= @item.form.id %>" data-column-id="<%= column.id %>"><%= column.name %></butotn>
      <% end %>
    </fieldset>
    <div class="entry-controller-error hide"></div>
  </div>
<% end %>

<%= jquery do %>
  $(".entry-controller [data-form-id]").on("click", function() {
    var $self = $(this);
    var formId = $self.data("form-id");
    var columnId = $self.data("column-id");

    $self.closest("fieldset").attr("disabled", true);
    $self.closest(".entry-controller").find(".entry-controller-error").addClass("hide").html("");
    $.ajax({
      url: <%== entry_apis_form_path(form_id: ":formId", column_id: ":columnId").to_json %>.replace(/:formId/, formId).replace(/:columnId/, columnId),
      success: function(data, status, xhr) {
        $self.closest(".entry-controller").before(data);
        SS.render();
      },
      error: function(xhr, status, error) {
        $self.closest(".entry-controller").find(".entry-controller-error").html(error).removeClass("hide");
      },
      complete: function(xhr, status) {
        $self.closest("fieldset").attr("disabled", false);
      }
    });
  });

  $('a.btn-file-upload').data('on-select', function($item) {
    $.colorbox.close();

    var fileId = $item.data('id');
    var humanizedName = $item.data('humanized-name');
    if (! fileId || ! humanizedName) {
      return;
    }

    var $element = $.colorbox.element();
    $element.siblings('input.file-id').val(fileId);
    $element.siblings('span.humanized-name').text(humanizedName);
    $element.siblings('.btn-file-delete').show();
  });

  $('a.btn-file-delete').on('click', function(e) {
    var $this = $(this);
    $this.siblings('input.file-id').val('');
    $this.siblings('span.humanized-name').text('');
    $this.hide();

    e.preventDefault();
    return false;
  });
<% end %>
